#!/bin/bash

# =======================================================
# Moup Server - 사용자 DB 영구 삭제 스크립트
# 이 스크립트는 매일 자정에 실행되어, 유예 기간이 지난
# 삭제 처리된 사용자들을 영구 삭제합니다.
# =======================================================

# -------------------------------------------------------
# 설정값
# -------------------------------------------------------

# API 엔드포인트 URL
API_URL="https://home.moup-server.com/admin/users"

# API 인증 토큰 (운영 환경에서는 환경 변수로 관리)
# -H "Authorization: Bearer [ADMIN_AUTH_TOKEN]"
AUTH_TOKEN="${ADMIN_AUTH_TOKEN}"

# -------------------------------------------------------
# 로그 기록
# -------------------------------------------------------
echo "========================================"
echo "사용자 DB 영구 삭제 작업 시작: $(date)"
echo "----------------------------------------"

# -------------------------------------------------------
# API 호출
# -------------------------------------------------------
RESPONSE=$(curl -s -X DELETE "${API_URL}" \
     -H "Authorization: Bearer ${AUTH_TOKEN}")

# -------------------------------------------------------
# 결과 분석 및 로그 기록
# -------------------------------------------------------
HTTP_STATUS=$(echo "$RESPONSE" | grep -oP 'HTTP/\S+\s\K\d+')

if [ -z "$HTTP_STATUS" ]; then
    echo "오류: 서버 응답을 받지 못했습니다."
    echo "스크립트 종료."
    exit 1
elif [ "$HTTP_STATUS" -eq 200 ]; then
    echo "성공: 사용자 DB 영구 삭제 완료."
    echo "응답: $RESPONSE"
else
    echo "오류: API 호출 실패. 상태 코드: $HTTP_STATUS"
    echo "응답: $RESPONSE"
fi

echo "----------------------------------------"
echo "작업 종료: $(date)"
echo "========================================"
