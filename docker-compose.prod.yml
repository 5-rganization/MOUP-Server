name: moup

services:
  # 1. Nginx (내부 리버스 프록시)
  moup-nginx:
    image: nginx:1.27-alpine
    container_name: moup-nginx
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - server
    networks:
      - default
      - npm-connect
    restart: unless-stopped

  # 2. Spring Server (API 서버)
  server:
    image: neoskycladdocker/moup
    env_file:
      - ./.env # 루트의 .env 파일 로드
    expose:
      - "8080" # 내부 Nginx 연결용 포트
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - default
    restart: unless-stopped

  # 3. MySQL (데이터베이스)
  mysql:
    image: mysql:8.0
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    environment:
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD} # .env 파일에서 변수 주입
      MYSQL_DATABASE: ${DATABASE_NAME}          # .env 파일에서 DB 이름 주입
      TZ: Asia/Seoul
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=Asia/Seoul
    healthcheck: # server가 기다릴 healthcheck
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DATABASE_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      # 홈서버 프로젝트 폴더 내 ./data/mysql에 저장
      - moup-db-data:/var/lib/mysql
      - ./db/init:/docker-entrypoint-initdb.d # 초기화 스크립트 (선택 사항)
    # ports는 운영 환경에서 노출하지 않음 (로컬 테스트 필요시 임시 추가)
    ports:
      - "127.0.0.1:3306:3306"
    networks:
      - default
    restart: unless-stopped # 운영 환경 재시작 정책

  # 4. Redis (캐시 서버)
  redis:
    image: redis:7-alpine
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    command: redis-server --requirepass ${REDIS_PASSWORD} # .env에서 비번 관리
    volumes:
      # 홈서버 프로젝트 폴더 내 ./data/redis에 저장
      - ./data/redis:/data
    networks:
      - default
    restart: unless-stopped # 운영 환경 재시작 정책

networks:
  default:
    name: moup-internal-net
  npm-connect:
    external: true
    name: proxy-net

volumes:
  moup-db-data: